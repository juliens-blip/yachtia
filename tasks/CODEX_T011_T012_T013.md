# ğŸ¯ MISSION CODEX - Fixes Perplexity RAG

**AssignÃ© Ã :** CODEX  
**Date:** 2026-01-24  
**PrioritÃ©:** HIGH  
**DÃ©pendances:** Aucune

---

## ğŸ“‹ Contexte

Les tests production montrent 6 problÃ¨mes critiques:
1. IA priorise articles gÃ©nÃ©raux au lieu de codes/lois (LY3, REG Yacht Code, OGSR)
2. Ne fusionne que 1-2 documents au lieu de 5+
3. Ignore contexte chiffrÃ© (50m yacht, annÃ©e 2000 â†’ >25 ans â†’ inspections renforcÃ©es)
4. Bruit: question Malte â†’ sources Monaco/VAT Italie
5. Ne boost pas assez codes/lois vs articles magazines

**Ton rÃ´le:** ImplÃ©menter 3 TODOs backend pour fix.

---

## ğŸ¯ TODO #1: T011-PERPLEXITY - Tags StructurÃ©s Documents

### Objectif
Ajouter mÃ©tadonnÃ©es structurÃ©es pour prioriser CODE/OGSR/LOI sur ARTICLE/BLOG

### TÃ¢ches

1. **Migration SQL: Ajouter colonnes tags**
```sql
-- yacht-legal-ai/database/migrations/014_add_document_tags.sql
ALTER TABLE documents ADD COLUMN IF NOT EXISTS document_type VARCHAR(50);
ALTER TABLE documents ADD COLUMN IF NOT EXISTS flag VARCHAR(100);
ALTER TABLE documents ADD COLUMN IF NOT EXISTS themes TEXT[];
CREATE INDEX idx_documents_type ON documents(document_type);
CREATE INDEX idx_documents_flag ON documents(flag);
```

2. **Script auto-tagging**
   - CrÃ©er `lib/document-tagger.ts`
   - RÃ¨gles dÃ©tection:
     - `document_type`: CODE (si title contient "LY3", "REG Yacht Code", "SOLAS"), OGSR (si "OGSR"), LOI (si "Act", "Regulation"), GUIDE (si "guide", "manual"), ARTICLE (dÃ©faut)
     - `flag`: Malta/Cayman/Marshall/etc (extraire de title/category)
     - `themes`: ["eligibility"] (si contient "nationality", "ownership"), ["inspection"] (si "survey", "inspection"), ["manning"] (si "crew", "captain"), etc

3. **Mettre Ã  jour ingestion**
   - Modifier `scripts/ingest-reference-docs.ts`
   - Appliquer auto-tagging avant INSERT
   - Propager tags aux chunks

4. **Update documents existants**
   - Script `scripts/retag-existing-documents.ts`
   - Lecture tous docs, apply tagger, UPDATE

### Livrables
- `database/migrations/014_add_document_tags.sql`
- `lib/document-tagger.ts`
- Ingestion scripts updated
- Script retag existants

---

## ğŸ¯ TODO #2: T012-PERPLEXITY - Extracteur Contexte AmÃ©liorÃ©

### Objectif
Extraire taille yacht, Ã¢ge, pavillon, codes mentionnÃ©s pour contexte prÃ©cis

### TÃ¢ches

1. **AmÃ©liorer `lib/context-extractor.ts`**

Ajouter extractions:
```typescript
interface YachtContext {
  size_m?: number;           // Taille en mÃ¨tres
  construction_year?: number; // AnnÃ©e construction
  age_years?: number;         // Ã‚ge calculÃ© (2026 - annÃ©e)
  flag?: string;             // Pavillon (Malta, Cayman, etc)
  mentioned_codes: string[]; // LY3, REG, CYC, OGSR, etc
  likely_over_500gt: boolean; // true si >50m
  inspection_category?: string; // "10-15y", "15-20y", "20-25y", ">25y"
}
```

2. **Patterns dÃ©tection**
   - Taille: `(\d+)\s*(m|metres|meters|ft|feet)`, convertir ftâ†’m
   - AnnÃ©e: `(19|20)\d{2}`, "built in YYYY", "constructed YYYY"
   - Pavillon: "Malta", "Cayman", "Marshall", "Red Ensign", etc
   - Codes: regex `\b(LY3|REG|CYC|OGSR|MLC|SOLAS|MARPOL)\b`
   - >500 GT: si size_m > 50
   - Inspection category: basÃ© sur age_years

3. **IntÃ©gration prompt**
   - Injecter YachtContext dans system prompt Gemini
   - Template: "CONTEXTE YACHT: {size}m, construit {year} (Ã¢ge {age} ans), pavillon {flag}, codes applicables: {codes}"

### Livrables
- `lib/context-extractor.ts` updated avec YachtContext
- Tests unitaires extraction
- IntÃ©gration dans `lib/gemini.ts`

---

## ğŸ¯ TODO #3: T013-PERPLEXITY - Re-ranking HiÃ©rarchique

### Objectif
Boost massif CODE/OGSR/LOI, penalty ARTICLE gÃ©nÃ©raliste + pavillon contradictoire

### TÃ¢ches

1. **AmÃ©liorer `lib/reranker.ts`**

Ajouter fonction `rerankWithHierarchy()`:
```typescript
function rerankWithHierarchy(
  chunks: SearchResult[],
  context: YachtContext
): SearchResult[] {
  return chunks.map(chunk => {
    let boost = 1.0;
    
    // Boost type document
    if (chunk.document_type === 'CODE' || chunk.document_type === 'OGSR' || chunk.document_type === 'LOI') {
      boost *= 3.0;
    } else if (chunk.document_type === 'GUIDE') {
      boost *= 1.5;
    } else if (chunk.document_type === 'ARTICLE') {
      boost *= 0.5; // penalty
    }
    
    // Boost pavillon match
    if (context.flag && chunk.flag === context.flag) {
      boost *= 2.5;
    } else if (context.flag && chunk.flag && chunk.flag !== context.flag) {
      boost *= 0.3; // forte penalty bruit
    }
    
    // Boost code mentionnÃ©
    if (context.mentioned_codes.some(code => 
      chunk.content.includes(code) || chunk.title.includes(code)
    )) {
      boost *= 2.0;
    }
    
    // Boost thÃ¨me exact
    if (chunk.themes?.some(theme => 
      context.question_themes?.includes(theme)
    )) {
      boost *= 1.5;
    }
    
    return {
      ...chunk,
      similarity: chunk.similarity * boost
    };
  }).sort((a, b) => b.similarity - a.similarity);
}
```

2. **IntÃ©grer dans pipeline**
   - `lib/rag-pipeline.ts`: appeler rerankWithHierarchy aprÃ¨s reranker existant
   - Logger boosts appliquÃ©s pour debug

### Livrables
- `lib/reranker.ts` avec rerankWithHierarchy
- `lib/rag-pipeline.ts` intÃ©grÃ©
- Tests: vÃ©rifier CODE/OGSR boost x3

---

## ğŸ“Š CritÃ¨res de Validation

**T011:**
- [ ] Migration 014 appliquÃ©e
- [ ] Auto-tagger dÃ©tecte type/flag/themes
- [ ] Documents existants retaggÃ©s

**T012:**
- [ ] Context extractor retourne YachtContext complet
- [ ] Test: "45m yacht built 2000 Malta" â†’ size=45, year=2000, age=26, flag=Malta
- [ ] Injection dans prompt Gemini

**T013:**
- [ ] Re-ranker boost CODE x3.0
- [ ] Penalty pavillon contradictoire x0.3
- [ ] Test: query "Malta eligibility" â†’ docs Malta en top-5, docs Cayman en bas

---

## ğŸ”” Notification Fin de TÃ¢che

Quand terminÃ©, Ã©crire dans `/home/julien/Documents/iayacht/tasks/CODEX_COMPLETED_T011_T012_T013.md`:
```
âœ… CODEX - TODOs T011, T012, T013 TERMINÃ‰S
Date: [DATE]
DurÃ©e: [XX min]
Status: DONE

RÃ©sumÃ©:
- T011: [rÃ©sumÃ©]
- T012: [rÃ©sumÃ©]
- T013: [rÃ©sumÃ©]

Tests: [rÃ©sultats]
```

---

**Deadline:** ASAP  
**Contact:** Claude (orchestrateur)
