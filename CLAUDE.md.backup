2# M√©moire Projet - iayacht

## üìã √âtat Global
- **T√¢che principale:** üîÑ Corrections probl√®mes Perplexity (RAG V3) - EN COURS
- **Progression:** 100% (T020-T042 termin√©s, tsc clean, tous tests PASS)
- **Orchestrateur actuel:** Claude (repris 2026-01-27 ~17h)
- **Session active:** orchestration-iayacht
- **Projet:** /home/julien/Documents/iayacht
- **Date d√©but:** 2026-01-26 14:35
- **Session:** orchestration-iayacht

## Task Assignment Queue
| ID | Task | Assigned To | Priority | Status | Created |
|----|------|-------------|----------|--------|---------|
| T020 | Context extraction complet | CODEX | HIGH | ‚úÖ DONE | 2026-01-26 14:35 |
| T021 | Filtrage strict documents | CODEX | HIGH | ‚úÖ DONE | 2026-01-26 14:35 |
| T022 | Multi-pass retrieval | CODEX | MEDIUM | ‚úÖ DONE | 2026-01-26 14:35 |
| T023 | Prompt Gemini enrichi | CODEX (w6) | MEDIUM | ‚úÖ DONE | 2026-01-27 11:38 |
| T024 | Tests E2E nouveaux | AMP (w4) | HIGH | ‚úÖ DONE | 2026-01-27 11:40 |
| T025 | Documentation V3 | AMP (w4) | LOW | ‚úÖ DONE | 2026-01-26 (cycle 3) |
| T030 | Multi-pass cible codes cites | CODEX (w6) | HIGH | ‚úÖ DONE | 2026-01-27 |
| T031 | Recherche metadata document | AMP-1 (w4) | HIGH | ‚úÖ DONE | 2026-01-27 |
| T032 | Augmenter topK multi-pass | CODEX (w6) | MEDIUM | ‚úÖ DONE (in T030) | 2026-01-27 |
| T033 | Tests scenarios Perplexity reels | CLAUDE | HIGH | ‚úÖ DONE | 2026-01-27 |
| T034 | Fix context-extractor-enhanced | CLAUDE | HIGH | ‚úÖ DONE | 2026-01-27 |
| T035 | Fix tsconfig target + TS errors | CODEX (w6) | MEDIUM | ‚úÖ DONE | 2026-01-27 |
| T036 | Fix answer used before assigned | AMP-1 (w4) | MEDIUM | ‚úÖ DONE | 2026-01-27 |
| T037 | Fix last TS error document-filter | CLAUDE | LOW | ‚úÖ DONE | 2026-01-27 |
| T038 | Am√©liorer fallback answer structur√© | CLAUDE | HIGH | ‚úÖ DONE | 2026-01-28 |
| T039 | Prompt Gemini structuration multi-questions | AMP-2 (w5) | HIGH | ‚úÖ DONE | 2026-01-28 |
| T040 | Logging fallback + test answer quality | CLAUDE | MEDIUM | ‚úÖ COMPLETED | 2026-01-28 |
| T-041 | MAJ refs embedding model | CODEX (w6) | MEDIUM | ‚úÖ DONE | 2026-01-28 |
| T-044 | Ajouter .env.example complet | CLAUDE | MEDIUM | ‚úÖ COMPLETED | 2026-01-28 |
| T-047 | Multi-pass queries doc-specific | CLAUDE | MEDIUM | ‚úÖ COMPLETED | 2026-01-28 |
| T-048 | Boost docs cit√©s question | CLAUDE | MEDIUM | ‚úÖ COMPLETED | 2026-01-28 |
| T-042 | Fix embedding 768/3072 dimension mismatch (REST API) | CLAUDE | CRITICAL | ‚úÖ DONE | 2026-01-28 |

## Inter-LLM Messages
| From | To | Message | Time |
|------|----|---------|------|
| AMP | CODEX | TODOs T020-T022: Context extraction + Filtrage + Multi-pass | 2026-01-26 14:35 |
| AMP | ANTIGRAVIT | TODOs T023-T024: Prompt enrichi + Tests E2E | 2026-01-26 14:35 |

## Task Completion Log
| Date | LLM | Task ID | Duration | Status | Notes |
|------|-----|---------|----------|--------|-------|
| 2026-01-26 14:35 | AMP | ORCHESTRATION | - | üîÑ IN PROGRESS | Distribution T020-T025, monitoring actif |
| 2026-01-26 16:05 | CODEX | T020 | 15min | ‚úÖ DONE | Context extraction + prompt contextuel |
| 2026-01-26 16:05 | CODEX | T021 | 12min | ‚úÖ DONE | Filtrage doc type + pavillon post-rerank |
| 2026-01-26 16:05 | CODEX | T022 | 18min | ‚úÖ DONE | Multi-pass retrieval + complex query gating |
| 2026-01-26 17:40 | CODEX | T-RAG-009 | 30min | ‚úÖ DONE | Tests E2E 5/5 PASS, rapport final g√©n√©r√© |
| 2026-01-26 17:40 | CODEX | T26 | 30min | ‚úÖ DONE | Tests E2E V3 + metrics logger + embedding cache |
| 2026-01-27 11:38 | CODEX | T023 | 15min | ‚úÖ DONE | Prompt Gemini: contexte yacht via buildContextPrompt; tsc --noEmit en √©chec (erreurs existantes) |
| 2026-01-27 11:50 | CODEX | T030 | 20min | ‚úÖ DONE | Multi-pass retrieval: pass3 codes cit√©s + pass1/2 topK augment√©s; tsc multi-pass en √©chec (config existante) |
| 2026-01-27 11:54 | CODEX | T035 | 20min | ‚úÖ DONE | tsconfig target es2020 + downlevelIteration; export type fixes scripts; tsc --noEmit toujours en √©chec (erreurs restantes) |
| 2026-01-27 11:40 | AMP | T024 | 10min | ‚úÖ DONE | Tests E2E: test-rag-v3-e2e.ts (+241 lignes), 5/5 PASS |
| 2026-01-27 11:45 | CLAUDE | RALPH | - | ‚úÖ DONE | Validation Ralph: E2E 5/5 PASS + integration OK |

## ü§ñ Monitoring Actif (Boucle toutes les 90s)

### Cycle 1 - 2026-01-26 14:37
- ‚úÖ CODEX: D√©marr√© (Clarifying required skills)
- ‚úÖ ANTIGRAVIT: D√©marr√© (Orbiting/thinking)
- ‚è≥ Attente r√©sultats...


### Cycle 3 - 2026-01-26 14:48 (4min50s)
- üîÑ CODEX: Designing multi-pass filtering (85% context)
- üîÑ ANTIGRAVIT: Orbiting (4m52s, exploring codebase)
- ‚úÖ AMP: T025 DONE - ARCHITECTURE_RAG_V3.md cr√©√© (890 lignes)

## üìù M√©moire du jour (2026-01-26)

### CODEX (T020-T022)
- T020: Context extraction compl√©t√©
  - `lib/context-extractor.ts`: extraction taille (m/ft), √¢ge (built in), prompt contextuel SOLAS/MLC si ‚â•50m, inspections si >20 ans
  - `lib/gemini.ts`: prompt enrichi avec `extractYachtContext` + `buildContextPrompt`
- T021: Filtrage post-rerank ajout√©
  - `lib/doc-filter.ts`: seuils `CODE:0.7`, `ARTICLE:0.8`, filtrage pavillon STRICT/BALANCED
  - `lib/search-documents.ts`: int√©gration filtres doc-type/pavillon apr√®s re-ranking + logs
  - `lib/rag-pipeline.ts`: branchement vers `searchDocuments` + filtre post-rerank
- T022: Multi-pass retrieval
  - `lib/multi-pass-retrieval.ts`: pass1 topK=10, pass2 enriched topK=5, merge + dedup
  - `lib/rag-pipeline.ts`: `isComplexQuery` ‚Üí multi-pass sinon single-pass
- Tests ajout√©s et ex√©cut√©s
  - `scripts/test-context-extractor-v3.ts`
  - `scripts/test-doc-filter-v3.ts`
  - `scripts/test-multi-pass-retrieval-v3.ts`
  - `scripts/test-rag-v3-integration.ts` (avec env vars mock√©es)

### AMP (orchestration)
- Distribution T020-T025 + suivi orchestration
- T025: documentation V3 (ARCHITECTURE_RAG_V3.md cr√©√© selon monitoring)

### ANTIGRAVIT
- Statut observ√©: exploration/orbiting dans monitoring (aucune t√¢che livr√©e confirm√©e ici)

### Cycle 6 - 2026-01-26 11:28
- ‚úÖ CODEX: T020-T022 DONE (13min)
  - context-extractor.ts (5.3K) ‚úì
  - doc-filter.ts (4.3K) ‚úì
  - multi-pass-retrieval.ts (3.1K) ‚úì
  - rag-pipeline.ts modifi√© ‚úì
  - search-documents.ts cr√©√© (11K) ‚úì
- üîÑ ANTIGRAVIT: Propagating (relanc√© apr√®s blocage)
- ‚úÖ AMP: T025 DONE - ARCHITECTURE_RAG_V3.md (890 lignes)
| 2026-01-28 | CLAUDE | T038 | 5min | ‚úÖ DONE | Fallback answer: structuration par doc groups + extraction phrases cl√©s au lieu de chunks bruts |
| 2026-01-28 | AMP-2 | T039 | 3min | ‚úÖ DONE | Prompt Gemini: d√©tection sous-questions + structuration ## forc√©e + interdiction chunks bruts |
| 2026-01-28 | CLAUDE | T040 | 5min | ‚úÖ COMPLETED | Logging: [RAG] FALLBACK USED vs GEMINI ANSWER OK + attempt/citations. Test quality: test-answer-quality.ts (sections/citations/raw chunks) |
| 2026-01-27 | CLAUDE | T031 | 4min | ‚úÖ DONE | Metadata search: searchByDocumentName + merge x2 boost codes cit√©s |
| 2026-01-27 | CLAUDE | T036 | 3min | ‚úÖ DONE | Fix TS2454: answer initialis√© '', analyzeDocuments ‚Üí generateAnswer |
| 2026-01-28 | CLAUDE | T-041 | 3min | ‚úÖ COMPLETED | MAJ refs text-embedding-004 ‚Üí gemini-embedding-001 (docs + tests) |
| 2026-01-28 | CLAUDE | T-044 | 3min | ‚úÖ COMPLETED | .env.example avec variables requises + optionnelles |
| 2026-01-28 | CLAUDE | T-047 | 3min | ‚úÖ COMPLETED | Queries CYC/OGSR sp√©cialis√©es + VAT/IYC + ann√©e incluse |
| 2026-01-28 | CLAUDE | T-048 | 2min | ‚úÖ COMPLETED | QUERY_CODE_BOOST √† 3.0 |
